app:
  data_dir: "./data"
  output_dir: "./output"
  log_level: "INFO"

observability:
  log_json_error_payload: true
  json_error_payload_max_chars: 0
  log_retry_attempts: true

ingest:
  encoding: "auto"
  chapter_regex: "^第[0-9一二三四五六七八九十百千]+章.*$"
  cleanup:
    strip_blank_lines: true
    normalize_fullwidth: true

split:
  chunk_size_tokens: 1200
  chunk_overlap_tokens: 120
  min_chunk_tokens: 200

llm:
  providers:
    deepseek:
      kind: "openai_compatible"
      base_url: "https://api.deepseek.com/v1"
      api_key_env: "DEEPSEEK_API_KEY"
    local_embedding:
      kind: "openai_compatible"
      base_url: "https://dashscope.aliyuncs.com/compatible-mode/v1"
      api_key_env: "DASHSCOPE_API_KEY"

  chat_endpoints:
    storyteller_default:
      provider: "deepseek"
      model: "deepseek-chat"
      temperature: 0.45
      timeout_s: 600
      max_concurrency: 4
      retries: 3

  embedding_endpoints:
    embedding_default:
      provider: "local_embedding"
      model: "text-embedding-v4"
      timeout_s: 60
      max_concurrency: 6
      retries: 3

  routes:
    storyteller_chat: "storyteller_default"
    storyteller_entity_chat: "storyteller_default"
    storyteller_narration_chat: "storyteller_default"
    storyteller_refine_chat: "storyteller_default"
    embedding: "embedding_default"

storyteller:
  language: "zh"
  style: "说书人/评书艺人风格，沉浸感强，保留关键对白和心理博弈"
  narration_preset: "medium" # short | medium | long
  # narration_ratio: [0.4, 0.5] # Optional explicit override, higher priority than preset.
  narration_temperature: 0.45
  entity_temperature: 0.1
  state_temperature: 0.1
  memory_top_k: 8
  recent_events_window: 5
  include_key_dialogue: true
  include_inner_thoughts: true
  refine_enabled: true
  refine_temperature: 0.35
  evidence_min_support_score: 0.18
  evidence_max_snippets: 3

  # Step execution (multi-chapter batching)
  # Defaults keep legacy behavior: step_size=1 means per-chapter execution.
  step_size: 5
  step_align: "auto" # auto | off
  step_checkpoint_enabled: true
  step_resume_mode: "restore" # continue | restore
  step_memory_mode: "per_chapter" # per_chapter | per_step_shared | off
  step_refine_mode: "inline" # inline | off

  # Retrieval concurrency in step mode.
  # 0/1: sequential. >1: concurrent (bounded by semaphore).
  step_retrieval_concurrency: 6

storage:
  sqlite_path: "./data/novel.db"
  lancedb_dir: "./data/lancedb"

cache:
  enabled: true
  backend: "sqlite"
  ttl_seconds: 2592000
